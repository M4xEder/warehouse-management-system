<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Relat칩rios de Expedi칞칚o</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- CSS -->
  <link rel="stylesheet" href="css/style.css">

  <!-- Bibliotecas -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    main { padding:20px; font-family:Arial,sans-serif; }
    h1 { text-align:center; margin-bottom:20px; }
    section { margin-bottom:20px; }
    select, button { padding:6px 10px; margin-right:10px; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { border:1px solid #ccc; padding:6px; font-size:14px; text-align:left; }
    th { background:#f0f0f0; }
    .resumo { background:#f9fafb; padding:10px; border:1px solid #ddd; margin-bottom:10px; }
    .btns { margin-top:5px; }
  </style>
</head>
<body>

  <!-- HEADER DIN츽MICO -->
  <div id="header"></div>

  <main id="app">
    <h1>Relat칩rios de Expedi칞칚o</h1>

    <section>
      <label>Escolher Lote:
        <select id="selectLoteRelatorio">
          <option value="">Selecione um lote</option>
        </select>
      </label>
      <button onclick="renderRelatorioLote()">游댌 Gerar Relat칩rio</button>

      <div class="btns">
        <button onclick="exportarRelatorioLoteExcel()">游늵 Excel</button>
        <button onclick="exportarRelatorioLotePDF()">游늯 PDF</button>
      </div>
    </section>

    <div id="resumoLote" class="resumo"></div>

    <table id="tabelaRelatorio">
      <thead>
        <tr>
          <th>Lote</th>
          <th>RZ</th>
          <th>Volume</th>
          <th>Status</th>
          <th>츼rea</th>
          <th>Rua</th>
          <th>Data Expedi칞칚o</th>
          <th>Hora Expedi칞칚o</th>
          <th>Mensagem</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

  </main>

  <!-- ================= SCRIPTS ================= -->
  <script src="js/supabase.js"></script>
  <script src="js/header.js"></script>
  <script src="js/state.js"></script>
  <script src="js/relatorios-expedicao.js"></script>

  <script>
    // -------------------------------
    // POPULAR SELECT COM LOTES
    // -------------------------------
    function popularSelectLotes() {
      const select = document.getElementById('selectLoteRelatorio');
      select.innerHTML = '<option value="">Selecione um lote</option>';

      state.lotes.forEach(l => {
        const option = document.createElement('option');
        option.value = l.nome;
        option.textContent = l.nome;
        select.appendChild(option);
      });
    }

    // -------------------------------
    // RENDER RELAT칍RIO
    // -------------------------------
    function renderRelatorioLote() {
      const loteSelecionado = document.getElementById('selectLoteRelatorio').value;
      const tbody = document.querySelector('#tabelaRelatorio tbody');
      const resumo = document.getElementById('resumoLote');
      tbody.innerHTML = '';
      resumo.innerHTML = '';

      if (!loteSelecionado) {
        alert('Selecione um lote');
        return;
      }

      const lote = state.lotes.find(l => l.nome === loteSelecionado);
      if (!lote) return;

      const alocadas = window.contarGaylordsDoLote(lote.nome);
      const expedidas = window.contarExpedidasDoLote(lote.nome);
      const naoAlocadas = Math.max(lote.total - (alocadas + expedidas), 0);

      // Mensagem de expedi칞칚o parcial
      const historico = state.historicoExpedidos.filter(e => e.lote === lote.nome);
      let msg = '';
      if (historico.length > 1) {
        msg = `Lote expedido em ${historico.length} etapas`;
      } else if (historico.length === 1 && historico[0].tipo === 'PARCIAL') {
        msg = 'Expedi칞칚o parcial';
      } else if (historico.length === 1 && historico[0].tipo === 'TOTAL') {
        msg = 'Expedi칞칚o completa';
      }

      // Resumo acima da tabela
      resumo.innerHTML = `
        <strong>Lote:</strong> ${lote.nome}<br>
        <strong>Total:</strong> ${lote.total}<br>
        <strong>Expedido:</strong> ${expedidas}<br>
        <strong>Alocadas:</strong> ${alocadas}<br>
        <strong>N칚o endere칞adas:</strong> ${naoAlocadas}<br>
        <strong>Mensagem:</strong> ${msg}
      `;

      // Preencher tabela
      // Gaylords expedidas
      historico.forEach(exp => {
        exp.detalhes.forEach(d => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${lote.nome}</td>
            <td>${d.rz || '-'}</td>
            <td>${d.volume || '-'}</td>
            <td>Expedida</td>
            <td>${d.area}</td>
            <td>${d.rua}</td>
            <td>${exp.data}</td>
            <td>${exp.hora}</td>
            <td>${exp.tipo}</td>
          `;
          tbody.appendChild(tr);
        });
      });

      // Gaylords alocadas e n칚o endere칞adas
      state.areas.forEach(area => {
        area.ruas.forEach(rua => {
          rua.posicoes.forEach((pos, index) => {
            if (pos.ocupada && pos.lote === lote.nome) {
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td>${lote.nome}</td>
                <td>${pos.rz || '-'}</td>
                <td>${pos.volume || '-'}</td>
                <td>Ativa</td>
                <td>${area.nome}</td>
                <td>${rua.nome}</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
              `;
              tbody.appendChild(tr);
            }
          });
        });
      });
    }

    // -------------------------------
    // EXPORTAR EXCEL
    // -------------------------------
    function exportarRelatorioLoteExcel() {
      const loteSelecionado = document.getElementById('selectLoteRelatorio').value;
      if (!loteSelecionado) return alert('Selecione um lote');

      const table = document.getElementById('tabelaRelatorio');
      const wb = XLSX.utils.table_to_book(table, { sheet: loteSelecionado });
      XLSX.writeFile(wb, `Relatorio_${loteSelecionado}.xlsx`);
    }

    // -------------------------------
    // EXPORTAR PDF
    // -------------------------------
    function exportarRelatorioLotePDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('l', 'mm', 'a4');
      const table = document.getElementById('tabelaRelatorio');

      doc.text(`Relat칩rio de Expedi칞칚o - ${document.getElementById('selectLoteRelatorio').value}`, 10, 10);
      doc.autoTable({ html: table, startY: 20 });
      doc.save(`Relatorio_${document.getElementById('selectLoteRelatorio').value}.pdf`);
    }

    // -------------------------------
    // INIT
    // -------------------------------
    window.addEventListener('DOMContentLoaded', () => {
      popularSelectLotes();
    });
  </script>
</body>
</html>

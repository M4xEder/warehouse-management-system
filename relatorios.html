<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Relat√≥rios de Expedi√ß√£o</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="css/style.css">
<style>
  body { font-family: Arial, sans-serif; padding:20px; background:#f5f5f5; }
  h1 { text-align:center; margin-bottom:20px; }
  select, button { padding:8px 12px; margin-right:10px; margin-bottom:20px; }
  table { width:100%; border-collapse: collapse; background:#fff; }
  th, td { border:1px solid #ddd; padding:8px; font-size:14px; text-align:left; }
  th { background:#16a34a; color:#fff; }
  tr:nth-child(even) { background:#f9f9f9; }
  .badge { padding:2px 6px; border-radius:4px; color:#fff; font-size:12px; }
  .total { background:#16a34a; }
  .parcial { background:#ca8a04; }
</style>
</head>
<body>

<h1>Relat√≥rios de Expedi√ß√£o</h1>

<div>
  <label for="selectLote">Selecione o Lote:</label>
  <select id="selectLote">
    <option value="">-- Selecione --</option>
  </select>

  <button onclick="gerarTabela()">Mostrar Informa√ß√µes</button>
</div>

<table id="tabelaRelatorio">
  <thead>
    <tr>
      <th>Lote</th>
      <th>Total</th>
      <th>Expedido</th>
      <th>Ativo</th>
      <th>N√£o Endere√ßado</th>
      <th>√Årea</th>
      <th>Rua</th>
      <th>Posi√ß√£o</th>
      <th>RZ</th>
      <th>Data/Hora Expedi√ß√£o</th>
      <th>Mensagem</th>
    </tr>
  </thead>
  <tbody>
    <!-- Conte√∫do preenchido via JS -->
  </tbody>
</table>

<script src="js/state.js"></script>
<script src="js/dashboard.js"></script>
<script>
  // Preencher select com todos os lotes
  function preencherSelectLotes() {
    const select = document.getElementById('selectLote');
    select.innerHTML = '<option value="">-- Selecione --</option>';
    state.lotes.forEach(l => {
      const option = document.createElement('option');
      option.value = l.nome;
      option.textContent = l.nome;
      select.appendChild(option);
    });
  }

  preencherSelectLotes();

  // Gerar tabela detalhada do lote selecionado
  function gerarTabela() {
    const loteSelecionado = document.getElementById('selectLote').value;
    const tbody = document.querySelector('#tabelaRelatorio tbody');
    tbody.innerHTML = '';

    if (!loteSelecionado) return alert('Selecione um lote');

    const lote = state.lotes.find(l => l.nome === loteSelecionado);
    if (!lote) return alert('Lote n√£o encontrado');

    const alocadas = contarGaylordsDoLote(lote.nome);
    const expedidas = contarExpedidasDoLote(lote.nome);
    const naoAlocadas = Math.max(lote.total - (alocadas + expedidas),0);

    // Filtrar hist√≥rico do lote
    const historico = state.historicoExpedidos.filter(e => e.lote === lote.nome);

    // Se n√£o houver expedi√ß√µes ainda
    if (historico.length === 0) {
      const posicoesAtivas = [];
      state.areas.forEach(area => {
        area.ruas.forEach(rua => {
          rua.posicoes.forEach(pos => {
            if (pos.ocupada && pos.lote === lote.nome) {
              posicoesAtivas.push({area: area.nome, rua: rua.nome, posicao: pos.posicao || '-', rz: pos.rz || '-'});
            }
          });
        });
      });

      posicoesAtivas.forEach(p => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${lote.nome}</td>
          <td>${lote.total}</td>
          <td>-</td>
          <td>1</td>
          <td>${naoAlocadas}</td>
          <td>${p.area}</td>
          <td>${p.rua}</td>
          <td>${p.posicao}</td>
          <td>${p.rz}</td>
          <td>-</td>
          <td>-</td>
        `;
        tbody.appendChild(row);
      });

      return;
    }

    // Para cada expedi√ß√£o do lote
    historico.forEach(exp => {
      const msg = exp.tipo === 'TOTAL'
        ? (() => {
            const parciaisAntes = state.historicoExpedidos.filter(e =>
              e.lote === lote.nome && e.tipo === 'PARCIAL' &&
              new Date(`${e.data} ${e.hora}`) < new Date(`${exp.data} ${exp.hora}`)
            ).length;
            return parciaisAntes > 0
              ? `üßæ Este lote teve ${parciaisAntes} expedi√ß√£o${parciaisAntes>1?'s':''} parcial${parciaisAntes>1?'s':''} antes da final`
              : '';
          })()
        : '';

      // Cada gaylord da expedi√ß√£o vira uma linha
      exp.detalhes.forEach(d => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${lote.nome}</td>
          <td>${lote.total}</td>
          <td><span class="badge ${exp.tipo==='TOTAL'?'total':'parcial'}">${exp.tipo}</span></td>
          <td>${alocadas}</td>
          <td>${naoAlocadas}</td>
          <td>${d.area}</td>
          <td>${d.rua}</td>
          <td>${d.posicao}</td>
          <td>${d.rz || '-'}</td>
          <td>${exp.data} ${exp.hora}</td>
          <td>${msg}</td>
        `;
        tbody.appendChild(row);
      });
    });
  }
</script>

</body>
</html>
